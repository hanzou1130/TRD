<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>TAUJ0ドライバ アーキテクチャ設計書</title>
	<style>
		:root {
			--primary-color: #2563eb;
			--secondary-color: #1e40af;
			--bg-color: #f8fafc;
			--text-color: #334155;
			--heading-color: #1e293b;
			--code-bg: #f1f5f9;
			--border-color: #e2e8f0;
		}

		body {
			font-family: 'Segoe UI', 'Meiryo', system-ui, sans-serif;
			line-height: 1.6;
			color: var(--text-color);
			background: var(--bg-color);
			margin: 0;
			padding: 2rem;
		}

		.container {
			max-width: 1000px;
			margin: 0 auto;
			background: white;
			padding: 3rem;
			border-radius: 12px;
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
		}

		h1 {
			color: var(--primary-color);
			border-bottom: 2px solid var(--border-color);
			padding-bottom: 1rem;
			margin-bottom: 2rem;
		}

		h2 {
			color: var(--secondary-color);
			margin-top: 2.5rem;
			border-left: 4px solid var(--primary-color);
			padding-left: 1rem;
		}

		h3 {
			color: var(--heading-color);
			margin-top: 2rem;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin: 1.5rem 0;
		}

		th,
		td {
			border: 1px solid var(--border-color);
			padding: 0.75rem;
			text-align: left;
		}

		th {
			background-color: var(--code-bg);
			font-weight: 600;
		}

		code {
			background-color: var(--code-bg);
			padding: 0.2rem 0.4rem;
			border-radius: 4px;
			font-family: 'Consolas', monospace;
			font-size: 0.9em;
			color: #d946ef;
		}

		pre {
			background-color: #1e293b;
			color: #e2e8f0;
			padding: 1.5rem;
			border-radius: 8px;
			overflow-x: auto;
		}

		pre code {
			background-color: transparent;
			color: inherit;
			padding: 0;
		}

		.mermaid {
			background: white;
			padding: 1rem;
			border: 1px solid var(--border-color);
			border-radius: 8px;
			margin: 1.5rem 0;
			text-align: center;
		}
	</style>
	<script type="module">
		import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
		mermaid.initialize({ startOnLoad: true });
	</script>
</head>

<body>
	<div class="container">
		<h1>TAUJ0ドライバ アーキテクチャ設計書</h1>

		<h2>1. はじめに</h2>
		<p>本ドキュメントは、ルネサス エレクトロニクス製マイクロコントローラ RH850F1KMS-1 向けの TAUJ0 (Timer Array Unit J)
			ドライバのソフトウェアアーキテクチャおよび設計について記述します。</p>

		<h2>2. システム概要</h2>
		<p>TAUJ0ドライバは、インターバルタイマとして構成されたTAUJ0周辺機能に対するハードウェア抽象化レイヤを提供します。これにより、アプリケーション層はハードウェアレジスタを直接操作することなく、タイマの初期化、開始、停止、およびインターバル設定を行うことができます。
		</p>

		<h3>2.1 ハードウェアコンテキスト</h3>
		<ul>
			<li><strong>マイクロコントローラ</strong>: Renesas RH850F1KMS-1</li>
			<li><strong>周辺機能</strong>: TAUJ0 (Timer Array Unit J, Unit 0)</li>
			<li><strong>チャネル</strong>: Channel 0 (TAUJ00)</li>
			<li><strong>クロックソース</strong>: PCLK (80MHzと仮定)</li>
		</ul>

		<h2>3. ソフトウェアアーキテクチャ</h2>

		<h3>3.1 レイヤ構造</h3>
		<p>ソフトウェアは以下のレイヤで構成されています：</p>
		<ul>
			<li><strong>アプリケーション層</strong>: <code>main.c</code> (ドライバを使用)</li>
			<li><strong>ドライバ層</strong>: <code>tauj0.c</code>, <code>tauj0.h</code> (ロジックを実装)</li>
			<li><strong>ハードウェア抽象化レイヤ (レジスタ)</strong>: <code>tauj0_regs.h</code> (メモリマップを定義)</li>
			<li><strong>ハードウェア</strong>: RH850F1KMS-1 デバイス</li>
		</ul>

		<h3>3.2 ファイル構成</h3>
		<table>
			<tr>
				<th>ファイル</th>
				<th>説明</th>
			</tr>
			<tr>
				<td><code>tauj0.c</code></td>
				<td>ドライバ実装 (ソース)</td>
			</tr>
			<tr>
				<td><code>tauj0.h</code></td>
				<td>公開API宣言 (ヘッダ)</td>
			</tr>
			<tr>
				<td><code>tauj0_regs.h</code></td>
				<td>レジスタ定義およびビットマスク</td>
			</tr>
		</table>

		<h2>4. コンポーネント設計</h2>

		<h3>4.1 機能説明</h3>
		<p>ドライバは TAUJ0 チャネル0 を <strong>インターバルタイマモード</strong> で動作させます。</p>
		<ul>
			<li><strong>カウンタ</strong>: ダウンカウント (または特定のモードに応じたアップカウント、ここでは標準的なインターバルロジック)。</li>
			<li><strong>インターバル</strong>: マイクロ秒単位で設定可能。</li>
			<li><strong>割り込み</strong>: カウンタ満了時に割り込み (INTTAUJ0I0) を生成。</li>
		</ul>

		<h3>4.2 API仕様</h3>

		<h4><code>void TAUJ0_Init(uint32_t interval_us)</code></h4>
		<p>TAUJ0チャネルを初期化します。</p>
		<ul>
			<li><strong>パラメータ</strong>: <code>interval_us</code> - タイマインターバル（マイクロ秒）。</li>
			<li><strong>操作</strong>:
				<ol>
					<li>タイマを停止 (TT0)。</li>
					<li>モード (CMOR0) をインターバルタイマに設定。</li>
					<li>初期インターバルを設定 (CDR0)。</li>
				</ol>
			</li>
		</ul>

		<h4><code>void TAUJ0_Start(void)</code></h4>
		<p>タイマカウンタを開始します。</p>
		<ul>
			<li><strong>操作</strong>: TS0ビットを設定。</li>
		</ul>

		<h4><code>void TAUJ0_Stop(void)</code></h4>
		<p>タイマカウンタを停止します。</p>
		<ul>
			<li><strong>操作</strong>: TT0ビットを設定。</li>
		</ul>

		<h4><code>void TAUJ0_SetInterval(uint32_t interval_us)</code></h4>
		<p>タイマインターバルを更新します。</p>
		<ul>
			<li><strong>パラメータ</strong>: <code>interval_us</code> - 新しいインターバル（マイクロ秒）。</li>
			<li><strong>計算式</strong>: <code>Counts = interval_us * (SystemClock / 1,000,000)</code></li>
		</ul>

		<h3>4.3 レジスタ使用状況</h3>
		<table>
			<tr>
				<th>レジスタ</th>
				<th>オフセット</th>
				<th>説明</th>
				<th>アクセス</th>
			</tr>
			<tr>
				<td><code>CDR0</code></td>
				<td>0x0000</td>
				<td>チャネルデータレジスタ (インターバル値)</td>
				<td>R/W</td>
			</tr>
			<tr>
				<td><code>CMOR0</code></td>
				<td>0x0080</td>
				<td>チャネルモードOSレジスタ (モード/クロック)</td>
				<td>R/W</td>
			</tr>
			<tr>
				<td><code>CSR0</code></td>
				<td>0x0040</td>
				<td>チャネルステータスレジスタ (オーバーフロー/アンダーフロー)</td>
				<td>R</td>
			</tr>
			<tr>
				<td><code>TS0</code></td>
				<td>0x0014</td>
				<td>タイマスタートレジスタ</td>
				<td>W</td>
			</tr>
			<tr>
				<td><code>TT0</code></td>
				<td>0x0018</td>
				<td>タイマストップレジスタ</td>
				<td>W</td>
			</tr>
		</table>

		<h2>5. 動的振る舞い</h2>

		<h3>5.1 初期化シーケンス</h3>
		<div class="mermaid">
			sequenceDiagram
			participant App as Application
			participant Drv as TAUJ0 Driver
			participant Reg as Registers

			App->>Drv: TAUJ0_Init(1000)
			Drv->>Reg: Write TT0 (Stop)
			Drv->>Reg: Write CMOR0 (Mode=Interval, CKS=0)
			Drv->>Drv: Calculate Counts (80 * 1000)
			Drv->>Reg: Write CDR0 (80000)
			Drv-->>App: Return
		</div>

		<h3>5.2 開始シーケンス</h3>
		<div class="mermaid">
			sequenceDiagram
			participant App as Application
			participant Drv as TAUJ0 Driver
			participant Reg as Registers

			App->>Drv: TAUJ0_Start()
			Drv->>Reg: Write TS0 (Start Trigger)
			Reg-->>Reg: Counter Starts
			Drv-->>App: Return
		</div>
	</div>
</body>

</html>